#!/bin/bash
##############################################################################
#
# File: pre-commit
#
# Purpose:
#       Git pre-commit hook to enforce coding standards
#
# Copyright notice and license:
#       See LICENSE.md in this directory.
#
# Author:
#       Terry Moore
#
# Notes:
#       Checks for linter suppression annotations without explanatory comments
#       Skips content inside fenced code blocks (``` ... ```)
#
##############################################################################

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

errors=0

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

# Check markdown files for markdownlint-disable without explanations
for file in $staged_files; do
    if [[ "$file" == *.md ]]; then
        # Process file, tracking whether we're inside a code block
        in_code_block=0
        line_num=0
        # shellcheck disable=SC2094  # sed inside loop reads same file separately
        while IFS= read -r line; do
            ((line_num++)) || true

            # Check for code block fence
            if [[ "$line" =~ ^\`\`\` ]]; then
                if [ $in_code_block -eq 0 ]; then
                    in_code_block=1
                else
                    in_code_block=0
                fi
                continue
            fi

            # Skip if inside code block
            if [ $in_code_block -eq 1 ]; then
                continue
            fi

            # Check for markdownlint-disable (real ones, not examples with broken syntax)
            if [[ "$line" =~ \<\!--[[:space:]]*markdownlint-disable.*MD[0-9] ]]; then
                # Extract the MD codes
                codes=$(echo "$line" | grep -oE 'MD[0-9]+' | tr '\n' ' ')

                # Check if next lines explain each code
                for code in $codes; do
                    # Look for explanation comment in next 5 lines
                    if ! sed -n "$((line_num+1)),$((line_num+5))p" "$file" 2>/dev/null | grep -q "<!-- $code:"; then
                        echo -e "${RED}ERROR:${NC} $file:$line_num"
                        echo "  markdownlint-disable uses $code but no explanation comment found"
                        echo "  Add: <!-- $code: reason for disabling -->"
                        ((errors++)) || true
                    fi
                done
            fi
        done < "$file"
    fi
done

# Check Python files for noqa without explanations
for file in $staged_files; do
    if [[ "$file" == *.py ]]; then
        line_num=0
        while IFS= read -r line; do
            ((line_num++)) || true
            # Check for bare noqa without code or explanation
            if [[ "$line" =~ \#[[:space:]]*noqa[[:space:]]*$ ]]; then
                echo -e "${RED}ERROR:${NC} $file:$line_num"
                echo "  Bare '# noqa' without error code or explanation"
                echo "  Use: # noqa: E501 - reason for suppression"
                ((errors++)) || true
            fi
            # Check for noqa with code but no explanation
            if [[ "$line" =~ \#[[:space:]]*noqa:[[:space:]]*[A-Z][0-9]+[[:space:]]*$ ]]; then
                echo -e "${YELLOW}WARNING:${NC} $file:$line_num"
                echo "  noqa suppression without explanation"
                echo "  Consider: # noqa: CODE - reason for suppression"
            fi
            # Check for type: ignore without explanation
            if [[ "$line" =~ \#[[:space:]]*type:[[:space:]]*ignore[[:space:]]*$ ]]; then
                echo -e "${YELLOW}WARNING:${NC} $file:$line_num"
                echo "  'type: ignore' without explanation"
                echo "  Consider: # type: ignore[error-code] - reason"
            fi
        done < "$file"
    fi
done

if [ "$errors" -gt 0 ]; then
    echo ""
    echo -e "${RED}Pre-commit hook failed with $errors error(s)${NC}"
    echo "Fix the issues above or use 'git commit --no-verify' to bypass"
    exit 1
fi

exit 0
